"use strict";var t,e,r=require("avalanche-js-crypto"),n=(t=require("regenerator-runtime"))&&"object"==typeof t&&"default"in t?t.default:t,s=require("avalanche-js-utils"),i=require("avalanche-js-network");function a(t,e,r,n,s,i,a){try{var o=t[i](a),c=o.value}catch(t){return void r(t)}o.done?e(c):Promise.resolve(c).then(n,s)}function o(t){return function(){var e=this,r=arguments;return new Promise((function(n,s){var i=t.apply(e,r);function o(t){a(i,n,s,o,c,"next",t)}function c(t){a(i,n,s,o,c,"throw",t)}o(void 0)}))}}function c(){return(c=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}).apply(this,arguments)}function u(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,(Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}(e=exports.TxStatus||(exports.TxStatus={})).NONE="NONE",e.INTIALIZED="INITIALIZED",e.SIGNED="SIGNED",e.PENDING="PENDING",e.CONFIRMED="CONFIRMED",e.REJECTED="REJECTED";var h,x=[{name:"nonce",length:32,fix:!1},{name:"gasPrice",length:32,fix:!1,transform:"hex"},{name:"gasLimit",length:32,fix:!1,transform:"hex"},{name:"shardID",length:16,fix:!1},{name:"toShardID",length:16,fix:!1},{name:"to",length:20,fix:!0},{name:"value",length:32,fix:!1,transform:"hex"},{name:"data",fix:!1}],m=[{name:"nonce",length:32,fix:!1},{name:"gasPrice",length:32,fix:!1,transform:"hex"},{name:"gasLimit",length:32,fix:!1,transform:"hex"},{name:"to",length:20,fix:!0},{name:"value",length:32,fix:!1,transform:"hex"},{name:"data",fix:!1}],f=function(t){return s.isHex(t)&&"0x"===t?s.hexToNumber("0x00"):s.isHex(t)&&"0x"!==t?s.hexToNumber(t):t},d=function(t){return"0x"===t?"0x":s.isAddress(t)?t:"0x"},p=function(t){var e=r.decode(t);if(11!==e.length&&8!==e.length)throw new Error("invalid rawTransaction");var n={id:"0x",from:"0x",rawTransaction:"0x",unsignedRawTransaction:"0x",nonce:new r.BN(s.strip0x(f(e[0]))).toNumber(),gasPrice:new r.BN(s.strip0x(f(e[1]))),gasLimit:new r.BN(s.strip0x(f(e[2]))),shardID:new r.BN(s.strip0x(f(e[3]))).toNumber(),toShardID:new r.BN(s.strip0x(f(e[4]))).toNumber(),to:"0x"!==d(e[5])?r.getAddress(d(e[5])).checksum:"0x",value:new r.BN(s.strip0x(f(e[6]))),data:e[7],chainId:0,signature:{r:"",s:"",recoveryParam:0,v:0}};if(8===e.length)return n.unsignedRawTransaction=t,n;try{n.signature.v=new r.BN(s.strip0x(f(e[8]))).toNumber()}catch(t){throw t}if(n.signature.r=r.hexZeroPad(e[9],32),n.signature.s=r.hexZeroPad(e[10],32),new r.BN(s.strip0x(f(n.signature.r))).isZero()&&new r.BN(s.strip0x(f(n.signature.s))).isZero())n.chainId=n.signature.v,n.signature.v=0;else{n.chainId=Math.floor((n.signature.v-35)/2),n.chainId<0&&(n.chainId=0);var i=n.signature.v-27,a=e.slice(0,8);0!==n.chainId&&(a.push(r.hexlify(n.chainId)),a.push("0x"),a.push("0x"),i-=2*n.chainId+8);var o=r.keccak256(r.encode(a));try{var c=r.recoverAddress(o,{r:r.hexlify(n.signature.r),s:r.hexlify(n.signature.s),recoveryParam:i});n.from="0x"===c?"0x":r.getAddress(c).checksum}catch(t){throw t}n.rawTransaction=t,n.id=r.keccak256(t)}return n},g=function(t){var e=r.decode(t);if(9!==e.length&&6!==e.length)throw new Error("invalid rawTransaction");var n={id:"0x",from:"0x",rawTransaction:"0x",unsignedRawTransaction:"0x",nonce:new r.BN(s.strip0x(f(e[0]))).toNumber(),gasPrice:new r.BN(s.strip0x(f(e[1]))),gasLimit:new r.BN(s.strip0x(f(e[2]))),shardID:0,toShardID:0,to:"0x"!==d(e[3])?r.getAddress(d(e[3])).checksum:"0x",value:new r.BN(s.strip0x(f(e[4]))),data:e[5],chainId:0,signature:{r:"",s:"",recoveryParam:0,v:0}};if(6===e.length)return n.unsignedRawTransaction=t,n;try{n.signature.v=new r.BN(s.strip0x(f(e[6]))).toNumber()}catch(t){throw t}if(n.signature.r=r.hexZeroPad(e[7],32),n.signature.s=r.hexZeroPad(e[8],32),new r.BN(s.strip0x(f(n.signature.r))).isZero()&&new r.BN(s.strip0x(f(n.signature.s))).isZero())n.chainId=n.signature.v,n.signature.v=0;else{n.chainId=Math.floor((n.signature.v-35)/2),n.chainId<0&&(n.chainId=0);var i=n.signature.v-27,a=e.slice(0,6);0!==n.chainId&&(a.push(r.hexlify(n.chainId)),a.push("0x"),a.push("0x"),i-=2*n.chainId+8);var o=r.keccak256(r.encode(a));try{var c=r.recoverAddress(o,{r:r.hexlify(n.signature.r),s:r.hexlify(n.signature.s),recoveryParam:i});n.from="0x"===c?"0x":r.getAddress(c).checksum}catch(t){throw t}n.rawTransaction=t,n.id=r.keccak256(t)}return n},v=function(){var t=o(n.mark((function t(e){return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t){setTimeout((function(){return t()}),e)})));case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}();(h=exports.TransactionEvents||(exports.TransactionEvents={})).transactionHash="transactionHash",h.error="error",h.confirmation="confirmation",h.receipt="receipt",h.track="track",h.cxConfirmation="cxConfirmation",h.cxReceipt="cxReceipt",h.cxTrack="cxTrack";var l=new i.Messenger(new i.HttpProvider("http://localhost:9500"),s.ChainType.Avalanche),T=function(){function t(t,e){this.blockNumbers=[],this.confirmations=0,this.confirmationCheck=0,this.cxStatus=exports.TxStatus.INTIALIZED,this.cxBlockNumbers=[],this.cxConfirmations=0,this.cxConfirmationCheck=0,this.messenger=t,this.txStatus=e,this.emitter=new i.Emitter,this.id="0x",this.shardID=this.messenger.currentShard}t.normalizeAddress=function(t){if("0x"===t)return"0x";if(r.AvalancheAddress.isValidChecksum(t)||r.AvalancheAddress.isValidBech32(t)||r.AvalancheAddress.isValidBech32TestNet(t))return r.getAddress(t).checksum;throw new Error("Address format is not supported")};var e=t.prototype;return e.setMessenger=function(t){this.messenger=t},e.setTxStatus=function(t){this.txStatus=t},e.getTxStatus=function(){return this.txStatus},e.setCxStatus=function(t){this.cxStatus=t},e.getCxStatus=function(){return this.cxStatus},e.isInitialized=function(){return this.getTxStatus()===exports.TxStatus.INTIALIZED},e.isSigned=function(){return this.getTxStatus()===exports.TxStatus.SIGNED},e.isPending=function(){return this.getTxStatus()===exports.TxStatus.PENDING},e.isRejected=function(){return this.getTxStatus()===exports.TxStatus.REJECTED},e.isConfirmed=function(){return this.getTxStatus()===exports.TxStatus.CONFIRMED},e.isCxPending=function(){return this.getCxStatus()===exports.TxStatus.PENDING},e.isCxRejected=function(){return this.getCxStatus()===exports.TxStatus.REJECTED},e.isCxConfirmed=function(){return this.getCxStatus()===exports.TxStatus.CONFIRMED},e.observed=function(){return this.emitter},e.trackTx=function(){var t=o(n.mark((function t(e,r){var s;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.messenger){t.next=2;break}throw new Error("Messenger not found");case 2:return t.next=4,this.messenger.send(i.RPCMethod.GetTransactionReceipt,e,this.messenger.chainType,"string"==typeof r?Number.parseInt(r,10):r);case 4:if(!(s=t.sent).isResult()||null===s.result){t.next=24;break}if(this.receipt=s.result,this.emitReceipt(this.receipt),this.id=s.result.transactionHash,this.confirmations+=1,!this.receipt){t.next=15;break}return this.receipt.status&&"0x1"===this.receipt.status?(this.receipt.byzantium=!0,this.txStatus=exports.TxStatus.CONFIRMED):this.receipt.status&&"0x0"===this.receipt.status?(this.receipt.byzantium=!0,this.txStatus=exports.TxStatus.REJECTED):void 0===this.receipt.status&&this.receipt.root&&(this.receipt.byzantium=!1,this.txStatus=exports.TxStatus.CONFIRMED),t.abrupt("return",!0);case 15:return this.txStatus=exports.TxStatus.PENDING,t.next=18,this.getBlockNumber(r);case 18:return this.blockNumbers.push("0x"+t.sent.toString("hex")),this.confirmationCheck+=1,t.abrupt("return",!1);case 22:t.next=31;break;case 24:return this.txStatus=exports.TxStatus.PENDING,t.next=27,this.getBlockNumber(r);case 27:return this.blockNumbers.push("0x"+t.sent.toString("hex")),this.confirmationCheck+=1,t.abrupt("return",!1);case 31:case"end":return t.stop()}}),t,this)})));return function(e,r){return t.apply(this,arguments)}}(),e.txConfirm=function(){var t=o(n.mark((function t(e,s,a,o){var c,u,h,x;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0===s&&(s=20),void 0===a&&(a=1e3),!(this.messenger.provider instanceof i.HttpProvider)){t.next=44;break}return this.txStatus=exports.TxStatus.PENDING,t.next=6,this.getBlockNumber(o);case 6:c=t.sent,u=0;case 9:if(!(u<s)){t.next=39;break}return t.prev=10,t.next=13,this.getBlockNumber(o);case 13:if(h=t.sent,x=c.add(new r.BN(0===u?u:1)),!h.gte(x)){t.next=25;break}return this.emitTrack({txHash:e,attempt:u,currentBlock:(c=h).toString(),shardID:o}),t.next=20,this.trackTx(e,o);case 20:if(!t.sent){t.next=23;break}return this.emitConfirm(this.txStatus),t.abrupt("return",this);case 23:t.next=26;break;case 25:u=u-1>=0?u-1:0;case 26:t.next=33;break;case 28:throw t.prev=28,t.t0=t.catch(10),this.txStatus=exports.TxStatus.REJECTED,this.emitConfirm(this.txStatus),t.t0;case 33:if(!(u+1<s)){t.next=36;break}return t.next=36,v(a);case 36:u+=1,t.next=9;break;case 39:throw this.txStatus=exports.TxStatus.REJECTED,this.emitConfirm(this.txStatus),new Error("The transaction is still not confirmed after "+s+" attempts.");case 44:return t.prev=44,t.next=47,this.trackTx(e,o);case 47:if(!t.sent){t.next=52;break}return this.emitConfirm(this.txStatus),t.abrupt("return",this);case 52:return t.next=54,this.socketConfirm(e,s,o);case 54:return t.abrupt("return",t.sent);case 56:t.next=63;break;case 58:throw t.prev=58,t.t1=t.catch(44),this.txStatus=exports.TxStatus.REJECTED,this.emitConfirm(this.txStatus),new Error("The transaction is still not confirmed after "+s*a+" mil seconds.");case 63:case"end":return t.stop()}}),t,this,[[10,28],[44,58]])})));return function(e,r,n,s){return t.apply(this,arguments)}}(),e.socketConfirm=function(t,e,r){var a=this;return void 0===e&&(e=20),new Promise((function(c,u){Promise.resolve(new i.NewHeaders(a.messenger,"string"==typeof r?Number.parseInt(r,10):r)).then((function(i){i.onData(function(){var u=o(n.mark((function o(u){var h;return n.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a.emitTrack({txHash:t,attempt:a.confirmationCheck,currentBlock:s.hexToNumber(h="hmy"===a.messenger.chainPrefix?u.params.result.Header.number:u.params.result.number),shardID:r}),a.blockNumbers.includes(h)){n.next=18;break}return n.next=5,a.trackTx(t,r);case 5:if(!n.sent){n.next=12;break}return a.emitConfirm(a.txStatus),n.next=9,i.unsubscribe();case 9:c(a),n.next=18;break;case 12:if(a.confirmationCheck!==e){n.next=18;break}return a.txStatus=exports.TxStatus.REJECTED,a.emitConfirm(a.txStatus),n.next=17,i.unsubscribe();case 17:c(a);case 18:case"end":return n.stop()}}),o)})));return function(t){return u.apply(this,arguments)}}()).onError(function(){var t=o(n.mark((function t(e){return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a.txStatus=exports.TxStatus.REJECTED,a.emitConfirm(a.txStatus),a.emitError(e),t.next=5,i.unsubscribe();case 5:u(e);case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}))}))},e.emitTransactionHash=function(t){this.emitter.emit(exports.TransactionEvents.transactionHash,t)},e.emitReceipt=function(t){this.emitter.emit(exports.TransactionEvents.receipt,t)},e.emitError=function(t){this.emitter.emit(exports.TransactionEvents.error,t)},e.emitConfirm=function(t){this.emitter.emit(exports.TransactionEvents.confirmation,t)},e.emitTrack=function(t){this.emitter.emit(exports.TransactionEvents.track,t)},e.emitCxReceipt=function(t){this.emitter.emit(exports.TransactionEvents.cxReceipt,t)},e.emitCxConfirm=function(t){this.emitter.emit(exports.TransactionEvents.cxConfirmation,t)},e.emitCxTrack=function(t){this.emitter.emit(exports.TransactionEvents.cxTrack,t)},e.getBlockNumber=function(){var t=o(n.mark((function t(e){var s;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.messenger.send(i.RPCMethod.BlockNumber,[],this.messenger.chainPrefix,"string"==typeof e?Number.parseInt(e,10):e);case 3:if(!(s=t.sent).isError()){t.next=6;break}throw s.message;case 6:return t.abrupt("return",new r.BN(s.result.replace("0x",""),"hex"));case 9:throw t.prev=9,t.t0=t.catch(0),t.t0;case 12:case"end":return t.stop()}}),t,this,[[0,9]])})));return function(e){return t.apply(this,arguments)}}(),e.getBlockByNumber=function(){var t=o(n.mark((function t(e){var r;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.messenger.send(i.RPCMethod.GetBlockByNumber,[e,!0],this.messenger.chainPrefix,"string"==typeof this.shardID?Number.parseInt(this.shardID,10):this.shardID);case 3:if(!(r=t.sent).isError()){t.next=6;break}throw r.message;case 6:return t.abrupt("return",r.result);case 9:throw t.prev=9,t.t0=t.catch(0),t.t0;case 12:case"end":return t.stop()}}),t,this,[[0,9]])})));return function(e){return t.apply(this,arguments)}}(),e.cxConfirm=function(){var t=o(n.mark((function t(e,s,a,o){var c,u,h,x;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0===s&&(s=20),void 0===a&&(a=1e3),!(this.messenger.provider instanceof i.HttpProvider)){t.next=43;break}return t.next=5,this.getBlockNumber(o);case 5:c=t.sent,u=0;case 8:if(!(u<s)){t.next=38;break}return t.prev=9,t.next=12,this.getBlockNumber(o);case 12:if(h=t.sent,x=c.add(new r.BN(0===u?u:1)),!h.gte(x)){t.next=24;break}return this.emitCxTrack({txHash:e,attempt:u,currentBlock:(c=h).toString(),toShardID:o}),t.next=19,this.trackCx(e,o);case 19:if(!t.sent){t.next=22;break}return this.emitCxConfirm(this.cxStatus),t.abrupt("return",this);case 22:t.next=25;break;case 24:u=u-1>=0?u-1:0;case 25:t.next=32;break;case 27:throw t.prev=27,t.t0=t.catch(9),this.cxStatus=exports.TxStatus.REJECTED,this.emitCxConfirm(this.cxStatus),t.t0;case 32:if(!(u+1<s)){t.next=35;break}return t.next=35,v(a);case 35:u+=1,t.next=8;break;case 38:throw this.cxStatus=exports.TxStatus.REJECTED,this.emitCxConfirm(this.cxStatus),new Error("The transaction is still not confirmed after "+s+" attempts.");case 43:return t.prev=43,t.next=46,this.trackCx(e,o);case 46:if(!t.sent){t.next=51;break}return this.emitCxConfirm(this.cxStatus),t.abrupt("return",this);case 51:return t.next=53,this.socketCxConfirm(e,s,o);case 53:return t.abrupt("return",t.sent);case 55:t.next=62;break;case 57:throw t.prev=57,t.t1=t.catch(43),this.cxStatus=exports.TxStatus.REJECTED,this.emitCxConfirm(this.cxStatus),new Error("The transaction is still not confirmed after "+s*a+" mil seconds.");case 62:case"end":return t.stop()}}),t,this,[[9,27],[43,57]])})));return function(e,r,n,s){return t.apply(this,arguments)}}(),e.trackCx=function(){var t=o(n.mark((function t(e,r){var s;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.messenger){t.next=2;break}throw new Error("Messenger not found");case 2:return t.next=4,this.messenger.send(i.RPCMethod.GetCXReceiptByHash,e,this.messenger.chainPrefix,"string"==typeof r?Number.parseInt(r,10):r);case 4:if(!(s=t.sent).isResult()||null===s.result){t.next=11;break}return this.emitCxReceipt(s.result),this.cxStatus=exports.TxStatus.CONFIRMED,t.abrupt("return",!0);case 11:return t.next=13,this.getBlockNumber(r);case 13:return this.cxBlockNumbers.push("0x"+t.sent.toString("hex")),this.cxConfirmationCheck+=1,this.cxStatus=exports.TxStatus.PENDING,t.abrupt("return",!1);case 18:case"end":return t.stop()}}),t,this)})));return function(e,r){return t.apply(this,arguments)}}(),e.socketCxConfirm=function(t,e,r){var a=this;return void 0===e&&(e=20),new Promise((function(c,u){Promise.resolve(new i.NewHeaders(a.messenger,"string"==typeof r?Number.parseInt(r,10):r)).then((function(i){i.onData(function(){var u=o(n.mark((function o(u){var h;return n.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a.emitCxTrack({txHash:t,attempt:a.cxConfirmationCheck,currentBlock:s.hexToNumber(h="hmy"===a.messenger.chainPrefix?u.params.result.Header.number:u.params.result.number),toShardID:r}),a.blockNumbers.includes(h)){n.next=18;break}return n.next=5,a.trackCx(t,r);case 5:if(!n.sent){n.next=12;break}return a.emitCxConfirm(a.cxStatus),n.next=9,i.unsubscribe();case 9:c(a),n.next=18;break;case 12:if(a.cxConfirmationCheck!==e){n.next=18;break}return a.cxStatus=exports.TxStatus.REJECTED,a.emitCxConfirm(a.cxStatus),n.next=17,i.unsubscribe();case 17:c(a);case 18:case"end":return n.stop()}}),o)})));return function(t){return u.apply(this,arguments)}}()).onError(function(){var t=o(n.mark((function t(e){return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a.cxStatus=exports.TxStatus.REJECTED,a.emitCxConfirm(a.cxStatus),a.emitError(e),t.next=5,i.unsubscribe();case 5:u(e);case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}))}))},t}(),w=function(t){function e(r,n,i){var a;return void 0===n&&(n=l),void 0===i&&(i=exports.TxStatus.INTIALIZED),(a=t.call(this,n,i)||this).id=r&&r.id?r.id:"0x",a.from=r&&r.from?r.from:"0x",a.nonce=r&&r.nonce?r.nonce:0,a.gasPrice=r&&r.gasPrice?new s.Unit(r.gasPrice).asWei().toWei():new s.Unit(0).asWei().toWei(),a.gasLimit=r&&r.gasLimit?new s.Unit(r.gasLimit).asWei().toWei():new s.Unit(0).asWei().toWei(),a.shardID=r&&void 0!==r.shardID?r.shardID:a.messenger.currentShard,a.toShardID=r&&void 0!==r.toShardID?r.toShardID:a.messenger.currentShard,a.to=r&&r.to?e.normalizeAddress(r.to):"0x",a.value=r&&r.value?new s.Unit(r.value).asWei().toWei():new s.Unit(0).asWei().toWei(),a.data=r&&r.data?r.data:"0x",a.chainId=r&&r.chainId?r.chainId:a.messenger.chainId,a.rawTransaction=r&&r.rawTransaction?r.rawTransaction:"0x",a.unsignedRawTransaction=r&&r.unsignedRawTransaction?r.unsignedRawTransaction:"0x",a.signature=r&&r.signature?r.signature:{r:"",s:"",recoveryParam:0,v:0},a.receipt=r&&r.receipt?r.receipt:void 0,a.cxStatus=a.isCrossShard()?exports.TxStatus.INTIALIZED:exports.TxStatus.NONE,a}u(e,t);var a,c,h=e.prototype;return h.getRLPUnsigned=function(){var t=this,e=[];return(this.messenger.chainType===s.ChainType.Avalanche?x:m).forEach((function(n){var i=t.txParams[n.name]||[];if(i=r.arrayify(r.hexlify("hex"===n.transform?s.add0xToString(i.toString(16)):i)),!0===n.fix&&n.length&&i.length!==n.length&&i.length>0)throw new Error("invalid length for "+n.name);if(!1===n.fix&&n.length&&(i=r.stripZeros(i)).length>n.length)throw new Error("invalid length for "+n.name);e.push(r.hexlify(i))})),null!=this.txParams.chainId&&0!==this.txParams.chainId&&(e.push(r.hexlify(this.txParams.chainId)),e.push("0x"),e.push("0x")),[r.encode(e),e]},h.getRLPSigned=function(t,e){var n=this.messenger.chainType===s.ChainType.Avalanche?11:9,i=r.splitSignature(e),a=27+(i.recoveryParam||0);return t.length===n&&(t.pop(),t.pop(),t.pop(),a+=2*this.chainId+8),t.push(r.hexlify(a)),t.push(r.stripZeros(r.arrayify(i.r)||[])),t.push(r.stripZeros(r.arrayify(i.s)||[])),r.encode(t)},h.getRawTransaction=function(){return this.rawTransaction},h.recover=function(t){var e=this.messenger.chainType===s.ChainType.Avalanche?p(t):g(t);return this.setParams(e),this},h.setParams=function(t){this.id=t&&t.id?t.id:"0x",this.from=t&&t.from?t.from:"0x",this.nonce=t&&t.nonce?t.nonce:0,this.gasPrice=t&&t.gasPrice?new s.Unit(t.gasPrice).asWei().toWei():new s.Unit(0).asWei().toWei(),this.gasLimit=t&&t.gasLimit?new s.Unit(t.gasLimit).asWei().toWei():new s.Unit(0).asWei().toWei(),this.shardID=t&&void 0!==t.shardID?t.shardID:this.messenger.currentShard,this.toShardID=t&&void 0!==t.toShardID?t.toShardID:this.messenger.currentShard,this.to=t&&t.to?e.normalizeAddress(t.to):"0x",this.value=t&&t.value?new s.Unit(t.value).asWei().toWei():new s.Unit(0).asWei().toWei(),this.data=t&&t.data?t.data:"0x",this.chainId=t&&t.chainId?t.chainId:0,this.rawTransaction=t&&t.rawTransaction?t.rawTransaction:"0x",this.unsignedRawTransaction=t&&t.unsignedRawTransaction?t.unsignedRawTransaction:"0x",this.signature=t&&t.signature?t.signature:{r:"",s:"",recoveryParam:0,v:0},this.setTxStatus("0x"!==this.rawTransaction?exports.TxStatus.SIGNED:exports.TxStatus.INTIALIZED)},h.map=function(t){var e=t(this.txParams);return this.setParams(e),this},h.isCrossShard=function(){return new r.BN(this.txParams.shardID).toString()!==new r.BN(this.txParams.toShardID).toString()},h.sendTransaction=function(){var t=o(n.mark((function t(){var e;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("tx"!==this.rawTransaction&&void 0!==this.rawTransaction){t.next=2;break}throw new Error("Transaction not signed");case 2:if(this.messenger){t.next=4;break}throw new Error("Messenger not found");case 4:return t.next=6,this.messenger.send(i.RPCMethod.SendRawTransaction,this.rawTransaction,this.messenger.chainType,"string"==typeof this.shardID?Number.parseInt(this.shardID,10):this.shardID);case 6:if(!(e=t.sent).isResult()){t.next=14;break}return this.id=e.result,this.emitTransactionHash(this.id),this.setTxStatus(exports.TxStatus.PENDING),t.abrupt("return",[this,e.result]);case 14:if(!e.isError()){t.next=20;break}return this.emitConfirm("transaction failed:"+e.error.message),this.setTxStatus(exports.TxStatus.REJECTED),t.abrupt("return",[this,"transaction failed:"+e.error.message]);case 20:throw this.emitError("transaction failed"),new Error("transaction failed");case 22:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),h.confirm=function(){var t=o(n.mark((function t(e,r,s,i,a){var o;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===r&&(r=20),void 0===s&&(s=1e3),void 0===i&&(i=this.txParams.shardID),void 0===a&&(a=this.txParams.toShardID),t.next=6,this.txConfirm(e,r,s,i);case 6:if(o=t.sent,this.isCrossShard()){t.next=9;break}return t.abrupt("return",o);case 9:if(!o.isConfirmed()){t.next=16;break}return t.next=12,this.cxConfirm(e,r,s,a);case 12:return t.abrupt("return",t.sent);case 16:return t.abrupt("return",o);case 17:case"end":return t.stop()}}),t,this)})));return function(e,r,n,s,i){return t.apply(this,arguments)}}(),a=e,(c=[{key:"txPayload",get:function(){return{from:this.txParams.from||"0x",to:this.txParams.to||"0x",shardID:this.txParams.shardID?s.numberToHex(this.shardID):"0x",toShardID:this.txParams.toShardID?s.numberToHex(this.toShardID):"0x",gas:this.txParams.gasLimit?s.numberToHex(this.txParams.gasLimit):"0x",gasPrice:this.txParams.gasPrice?s.numberToHex(this.txParams.gasPrice):"0x",value:this.txParams.value?s.numberToHex(this.txParams.value):"0x",data:this.txParams.data||"0x",nonce:this.txParams.nonce?s.numberToHex(this.nonce):"0x"}}},{key:"txParams",get:function(){return{id:this.id||"0x",from:this.from||"",nonce:this.nonce||0,gasPrice:this.gasPrice||new s.Unit(0).asWei().toWei(),gasLimit:this.gasLimit||new s.Unit(0).asWei().toWei(),shardID:void 0!==this.shardID?this.shardID:this.messenger.currentShard,toShardID:void 0!==this.toShardID?this.toShardID:this.messenger.currentShard,to:e.normalizeAddress(this.to)||"0x",value:this.value||new s.Unit(0).asWei().toWei(),data:this.data||"0x",chainId:this.chainId||0,rawTransaction:this.rawTransaction||"0x",unsignedRawTransaction:this.unsignedRawTransaction||"0x",signature:this.signature||{r:"",s:"",recoveryParam:0,v:0}}}}])&&function(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}(a.prototype,c),Object.defineProperty(a,"prototype",{writable:!1}),e}(T),S=function(t){function e(e,r,n){void 0===r&&(r=l),void 0===n&&(n=exports.TxStatus.INTIALIZED);var i=e.from,a=e.to,o=void 0!==i?i.split(s.AddressSuffix):["0x",void 0],u=void 0!==a?a.split(s.AddressSuffix):["0x",void 0],h=o[0],x=void 0!==o[1]?Number.parseInt(o[1],10):void 0!==e.shardID?e.shardID:0,m=c({},e,{from:h,to:u[0],shardID:x,toShardID:void 0!==u[1]?Number.parseInt(u[1],10):void 0!==e.toShardID?e.toShardID:0});return t.call(this,m,r,n)||this}return u(e,t),e}(w),I=function(){function t(t){this.messenger=t}t.getContractAddress=function(t){var e=t.txParams,n=e.nonce;return r.getAddress(r.getContractAddress(r.getAddress(e.from).checksum,Number.parseInt(""+n,10))).checksum};var e=t.prototype;return e.setMessenger=function(t){this.messenger=t},e.newTx=function(t,e){return void 0===e&&(e=!1),e?new S(t,this.messenger,exports.TxStatus.INTIALIZED):new w(t,this.messenger,exports.TxStatus.INTIALIZED)},e.clone=function(t){return new w(t.txParams,this.messenger,exports.TxStatus.INTIALIZED)},e.recover=function(t){var e=new w({},this.messenger,exports.TxStatus.INTIALIZED);return e.recover(t),e},t}();exports.AbstractTransaction=function(){},exports.RLPSign=function(t,e){var n=t.getRLPUnsigned(),s=n[0],i=n[1],a=c({},t.txParams,{unsignedRawTransaction:s});t.setParams(a);var o=r.sign(r.keccak256(s),e);return[o,t.getRLPSigned(i,o)]},exports.ShardingTransaction=S,exports.Transaction=w,exports.TransactionBase=T,exports.TransactionFactory=I,exports.defaultMessenger=l,exports.handleAddress=d,exports.handleNumber=f,exports.recover=p,exports.recoverETH=g,exports.sleep=v,exports.transactionFields=x,exports.transactionFieldsETH=m;
//# sourceMappingURL=avalanche-js-transaction.cjs.production.min.js.map
